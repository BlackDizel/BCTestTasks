/*
 * Copyright (C) 2009 The Android Open Source Project
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *      http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */

// OpenGL ES 2.0 code

#include <jni.h>
#include <android/log.h>

#include <GLES2/gl2.h>
#include <GLES2/gl2ext.h>

#include <stdio.h>
#include <stdlib.h>
#include <math.h>
#include <string.h>

#define  LOG_TAG    "libgl2jni"
#define  LOGI(...)  __android_log_print(ANDROID_LOG_INFO,LOG_TAG,__VA_ARGS__)
#define  LOGE(...)  __android_log_print(ANDROID_LOG_ERROR,LOG_TAG,__VA_ARGS__)

static void printGLString(const char *name, GLenum s) {
    const char *v = (const char *) glGetString(s);
    LOGI("GL %s = %s\n", name, v);
}

static void checkGlError(const char* op) {
    for (GLint error = glGetError(); error; error
            = glGetError()) {
        LOGI("after %s() glError (0x%x)\n", op, error);
    }
}


#pragma region texture

//hardcode texture atlas
char tex[] ="0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000011110000000000000000000000000000000000001111111100000000000000000000000000000000111111111111111111111111111100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000011111111000000000000000000000000000000000000111111110000000000000000000000001111111111111111111111111111111111111111111100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000001111000000000000000000000000000000000000000011111111000000000000000000001111111111110000000000001111000000000000111111110000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000111100000000000000000000000000000000000000001111111100000000000000001111111111110000000000001111000000000000000000001111111100000000000000000000000011111111111100000000000000000000111111111111000000000000000000000000000000000000000000000000000000000000111111111111111111111111111111111111111111111111111111110000000000000000111111110000000000001111111100000000000000000000111111110000000000000000000000001111111111110000000000000000000011111111111100000000000000000000000000000000000000000000000000000000000011111111111111111111111111111111111111111111111111111111000000000000000011111111000000000000111111110000000000000000000011111111000000000000000000000000111111111111000000000000000000001111111111110000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000001111111100000000000000001111111100000000000011111111111100000000000011111111111100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000111111110000000000000000000011111111000000000000111111111111111111111111111100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000011111111000000000000000000000000000000000000000000001111111111111111111100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000001111111100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000001111000000000000000000000000000000000000000000000000000011111111000000000000000000000000000000001111111111110000000000000000111111110000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000011111111111100000000000000000000000000000000000000000000000011111111000000000000000000000000000000001111111111111111000000000000000011111111000000000000000000000000000000000000000011111111000000000000000000000000000000000000000000000000000000001111111111111111111100000000000000000000000000000000000000000000000000001111111100000000000000000000000000001111111100001111111100000000000000001111111100000000000000000000000000000000111111111111111100000000000000000000000000000000000000000000000011111111111111111111000000000000000000000000000000000000000000000000000000000000111111110000000000000000000000001111111100000000111111110000000000000000111111110000000000000000000000001111111111111111000000000000000000000000000000000000000000000000111111111111111100000000000000000000000000000000000000000000000000000000000000000000000011111111000000000000000000001111111100000000000011111111000000000000000011111111000000000000000011111111111100000000000000000000000000000000000000000000000000001111111111111111000000000000000000000000000000000000000000000000000000000000000000000000000000001111111111110000000000001111111100000000000000001111111100000000000000001111111100000000000011111111000000000000000000000000000000000000000000000000111111111111111111110000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000011111111111111111111111100000000000000000000111111110000000000000000111111110000111111111111000000000000000000000000000000000000000000001111111111111111111100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000111111111111111100000000000000000000000011111111000000000000000011111111111111110000000000000000000000000000000000000000000000001111111111110000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000001111111111110000000000000000000000000000000000000000000000000000111100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000011111111111111110000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000011111111000000000000000000000000000000001111111111110000000000000000000011111111111111110000000011111111111111111111111100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000011111111000000000000111111110000000000000000000011111111000000000000000000001111111111111111111100001111000000000000111111111111000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000001111111100000000000011111111000000000000000000001111111100000000000000001111111100000000111111111111000000000000000000001111111100000000000000000000000011111111111100000000000000000000111111111111000000001111000000000000000000000000000000000000000000000000111111110000000000001111111100000000000000000000111111110000000000000000111111110000000000001111111111110000000000000000111111110000000000000000000000001111111111110000000000000000000011111111111111111111111100000000000000000000000000000000000000000000000011111111000000000000111111110000000000000000000011111111000000000000000011111111000000000000111111111111000000000000000011111111000000000000000000000000111111111111000000000000000000001111111111111111000000000000000000000000000000000000000000000000000000001111111100000000111111111111111100000000000011111111111100000000000000001111111111111111111111110000111111110000000011111111111100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000011111111111111110000000011111111111111111111111100000000000000000000000011111111111111110000000011111111111111111111111100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000001111111111110000000000000000111111111111111100000000000000000000000000000000000000000000000000000000111111111111111100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000011111111000000000000000000000000000000000000000011111111111111111111000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000111111111111111100000000000000000000000000000000000011111111111111111111111111110000000000001111111100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000111111110000111111110000000000000000000000000000000011111111111100000000000011111111111100000000000011111111000000000000000000000000000000001111111111111111111111110000000000000000000000000000000000000000000000000000000000000000000000000000000000000000111111110000000011111111000000000000000000000000000000001111111100000000000000000000111111110000000000001111111100000000000000000000000011111111111111111111111111111111111111110000000000000000000000000000000000000000000000000000000000000000000000001111111100000000000000001111111100000000000000000000000000000000111111110000000000000000000011111111000000000000111111110000000000000000111111111111111100000000000000000000000011111111111111110000000000000000000000000000000000000000000000000000000000001111111100000000000000000000111111110000000000000000000000000000000011111111000000000000000000001111000000000000111111111111000000000000111111111111000000000000000000000000000000000000000011111111111100000000000000000000000000000000000000000000000000001111111111111111111111111111111111111111111111111111111100000000000000000000111111110000000000001111000000000000111111111111000000000000000011111111000000000000000000000000000000000000000000000000111111110000000000000000000000000000000000000000000000000000111111111111111111111111111111111111111111111111111111110000000000000000000011111111111111111111111111111111111111111111000000000000000011111111000000000000000000000000000000000000000000000000000000001111111100000000000000000000000000000000000000000000000000000000000000000000000000000000111111110000000000000000000000000000000000000000000011111111111111111111111111110000000000000000000000001111111100000000000000000000000000000000000000000000000000000000111111110000000000000000000000000000000000000000000000000000000000000000000000000000000011111111000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000111111111111111111111111000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000001111111111111111111111111111111111111111000000000000000011111111000000000000000000000000000000000000000000000000000000001111111100000000000000000000000000000000000000000000000011111111111111111111111111111111000000000000000011111111000000000000000000001111111111110000000000000000000000001111111111110000000000001111111100000000000000000000000000000000000000000000000000000000111111110000000000000000000000000000000000000000000000001111111111111111111111111111111100000000000000001111111100000000000000001111111100000000000000000000000000000000000000001111111100000000000011111111000000000000000000000000000000000000000000000000111111110000000000000000000000000000000000000000000000000000111111110000000000000000111111110000000000000000111111110000000000000000111111110000000000000000000000000000000000000000111111110000000000001111111111110000000000000000000000000000000000000000111111111111000000000000000000000000000000000000000000000000000011111111000000000000000011111111000000000000000011111111000000000000000011111111000000000000000000000000000000000000000011111111000000000000000011111111111111110000000000000000000000001111111111111111000000000000000000000000000000000000000000000000000000001111111100000000000000001111111111110000000011111111111100000000000000001111111100000000000000000000000000000000000000001111111100000000000000000000000011111111111111111111111111111111111111110000000000000000000000000000000000000000000000000000000000000000111111110000000000000000000011111111111111111111111100000000000000000000000011111111111100000000000000000000000011111111111100000000000000000000000000000000000011111111111111111111111100000000000000000000000000000000000000000000000000000000000000000000000011111111000000000000000000000000111111111111111100000000000000000000000000000000111111111111111111111111111111111111111100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000111111111111111111111111000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000";

GLuint gProgramT;
//textured shader vertex
static const char gVertexShaderT[] = 
	"attribute vec4 a_position;   \n"
	"attribute vec2 a_texCoord;   \n"
	"varying vec2 v_texCoord;     \n"
	"void main()                  \n"
	"{                            \n"
	"   gl_Position = a_position; \n"
	"   v_texCoord = a_texCoord;  \n"
	"}                            \n";

//textured shader fragment
static const char gFragmentShaderT[] =
	"precision mediump float;								\n"
	"varying vec2 v_texCoord;								\n"
	"uniform sampler2D s_texture;							\n"
	"void main()											\n"
	"{														\n"
	"  gl_FragColor = texture2D( s_texture, v_texCoord );	\n"
	"}														\n";

				


GLubyte testpixels[64*64*4];
GLuint createSimpleTexture2D(GLuint _textureid, GLubyte* pixels,int width, int height) 
{
        glActiveTexture(GL_TEXTURE0);
        glBindTexture(GL_TEXTURE_2D, _textureid);

		for (int i=0;i<16384;++i)
			pixels[i]=tex[i]=='1'?255:0;
       
		glTexImage2D(GL_TEXTURE_2D, 0, GL_RGBA, width, height, 0, GL_RGBA,GL_UNSIGNED_BYTE, pixels);
		
        glTexParameteri(GL_TEXTURE_2D, GL_TEXTURE_MIN_FILTER, GL_NEAREST );
        glTexParameteri(GL_TEXTURE_2D, GL_TEXTURE_MAG_FILTER, GL_NEAREST );

        return _textureid;
}
#pragma endregion


static const char gVertexShader[] =
            "uniform mat4 uMVPMatrix;\n" 
            "attribute vec4 vPosition;\n" 
            "void main() {\n" 
            "  gl_Position = uMVPMatrix * vPosition;\n" 
            "}\n";

static const char gFragmentShader[] = 
    "precision mediump float;\n"
    "void main() {\n"
    "  gl_FragColor = vec4(1.0, 1.0, 1.0, 1.0);\n"
    "}\n";


GLuint loadShader(GLenum shaderType, const char* pSource) {
    GLuint shader = glCreateShader(shaderType);
    if (shader) 
	{
        glShaderSource(shader, 1, &pSource, NULL);
        glCompileShader(shader);        
    }
    return shader;
}

GLuint createProgram(const char* pVertexSource, const char* pFragmentSource) {
    GLuint vertexShader = loadShader(GL_VERTEX_SHADER, pVertexSource);
    GLuint pixelShader = loadShader(GL_FRAGMENT_SHADER, pFragmentSource);

    GLuint program = glCreateProgram();
    if (program) {
        glAttachShader(program, vertexShader);
        glAttachShader(program, pixelShader);
        glLinkProgram(program);        
    }    
	return program;
}

GLuint gProgram;
int screenW,screenH;

bool setupGraphics(int w, int h) 
{
	gProgram = createProgram(gVertexShader, gFragmentShader);    
	gProgramT = createProgram(gVertexShaderT, gFragmentShaderT);

	createSimpleTexture2D(0, testpixels, 64, 64);
	
		
	glViewport(0, 0, w, h);
	screenW=w;screenH=h;

	return true;
}

#pragma region myCode
class Vector2
{
public:
		float X;
		float Y;
		Vector2(float x,float y)
		{
			X=x; Y=y;
		}
		Vector2(){X=0;Y=0;}
		static float Length(Vector2 *one, Vector2 *two)
		{
			return sqrtf(powf(one->X - two->X,2)+powf(one->Y - two->Y,2));
		}
};


struct Rectangle
{
	Vector2 *Position;
	float Width,Height;
	Rectangle(float x,float y, float w, float h)
	{
		Position = new Vector2(x,y);		
		Width=w;
		Height=h;
	}
};

struct Coin
{
	Vector2 *Position;
	bool IsVisible;
	Coin (float x,float y)
	{
		Position = new Vector2(x,y);
		IsVisible=true;
	}
	Coin()
	{
		Position = new Vector2(0,0);
		IsVisible=true;
	}
};

//определяет текущее состояние игры: gsSTART - Начальный экран, gsGAME - игра, gsFINISH - экран победы/поражения
enum state { gsSTART, gsGAME, gsFINISH};
state GS = gsSTART;

//позиция камеры
float camX=0;

//таймер анимации. правильнее было бы завязываться на системное время
int timer=0;

//игрок - позиция и размеры 
Rectangle *Player = new Rectangle(-.6,0,0.2f,0.2f);

//платформы - позиция и размеры
const int platfromsCount = 5; //why not?
Rectangle *platforms[platfromsCount] = 
{
	new Rectangle(-0.75f,-0.3f,0.6f,0.2f),
	new Rectangle(0.15f,-0.3f,0.6f,0.2f),
	new Rectangle(1.15f,-0.3f,0.6f,0.2f),
	new Rectangle(2.15f,-0.3f,0.6f,0.2f),
	new Rectangle(3.15f,-0.3f,0.6f,0.2f)
};

const int coinsCount = 6; //why not?
//массив позиций монеток
Coin *coins[coinsCount]=
{
	new Coin(-.2,.4),
	new Coin(0, 0.5),
	new Coin(0.4,0.4),
	new Coin(1-.2,.4),
	new Coin(1+0, 0.5),
	new Coin(1+0.4,0.4)

};

//отрисовка восьмиугольника на позиции монетки
void DrawCoin(Coin *coin)
{
	if (coin->IsVisible)
	{
		Vector2 *coinPos=coin->Position;
		GLfloat arr [16]=
		{
			coinPos->X-0.03,
			coinPos->Y+0.05,

			coinPos->X-0.05,
			coinPos->Y+0.03,

			coinPos->X-0.05,
			coinPos->Y-0.03,
		
			coinPos->X-0.03,
			coinPos->Y-0.05,
		
			coinPos->X+0.03,
			coinPos->Y-0.05,
		
			coinPos->X+0.05,
			coinPos->Y-0.03,
		
			coinPos->X+0.05,
			coinPos->Y+0.03,
		
			coinPos->X+0.03,
			coinPos->Y+0.05
		};
		
		GLuint gvPositionHandle = glGetAttribLocation(gProgram, "vPosition");
		glVertexAttribPointer(gvPositionHandle, 2, GL_FLOAT, GL_FALSE, 0, arr);
		glEnableVertexAttribArray(gvPositionHandle);
		glDrawArrays(GL_TRIANGLE_FAN, 0, 8);
	}
}
	 
//орисовка платформы или игрока
void DrawRectangle(Rectangle *r)
{	
	GLfloat arr[8]=
	{
		r->Position->X,
		r->Position->Y,

		r->Position->X,
		r->Position->Y + r->Height,
		
		r->Position->X + r->Width,
		r->Position->Y + r->Height,
		
		r->Position->X + r->Width,
		r->Position->Y
	};
	GLuint gvPositionHandle = glGetAttribLocation(gProgram, "vPosition");
	glVertexAttribPointer(gvPositionHandle, 2, GL_FLOAT, GL_FALSE, 0, arr);
    glEnableVertexAttribArray(gvPositionHandle);
	glDrawArrays(GL_TRIANGLE_FAN, 0, 4);

}

//орисовка кнопки
void DrawButton()
{	
	GLfloat arr[16]=
	{
		-0.4, -0.2,
		-0.6, -0.3,
		-0.6, -0.5,
		-0.4, -0.6,
		 0.4, -0.6,
		 0.6, -0.5,
		 0.6, -0.3,
		 0.4, -0.2
	};
	GLuint gvPositionHandle = glGetAttribLocation(gProgram, "vPosition");
	glVertexAttribPointer(gvPositionHandle, 2, GL_FLOAT, GL_FALSE, 0, arr);
    glEnableVertexAttribArray(gvPositionHandle);
    glDrawArrays(GL_TRIANGLE_FAN, 0, 8);
    
}

Vector2 *NumPos[] =
{
	new Vector2(-0.1,0),
	new Vector2(-0.0,0),
	new Vector2(0.1,0),
	new Vector2(0.2,0)
};
GLushort indices[] = { 0, 1, 2, 0, 2, 3 };
GLsizei stride = 5 * sizeof(GLfloat); // 3 for position, 2 for texture
GLuint gvTexCoordHandleT;
GLuint gvPositionHandleT;
GLuint gvSamplerHandleT;

//отрисовка цифры. pos - позиция отрисовки, timer - кадр анимации (0-9)
void DrawNumber(Vector2 *pos,int timer)
{
	GLfloat vVertices[]=
	{
	pos->X-.06f, pos->Y+.06f, 0.0f, // Position 0
	.0f, .0f, // TexCoord 0
				
	pos->X-.06f, pos->Y-.06f, 0.0f, // Position 1
	1.0f, .0f, // TexCoord 1
				
	pos->X+.06f, pos->Y-.06f, 0.0f, // Position 2
	1.0f, 1.0f, // TexCoord 2
				
	pos->X+.06f, pos->Y+.06f, 0.0f, // Position 3
	.0f, 1.0f // TexCoord 3	
	};
	
	vVertices[3] = (timer/5)*(18/64.0f); //y1
	vVertices[4] = (timer%5)*(12/64.0f); //x1
		
	vVertices[8] = 18/64.0f+ vVertices[3];
	vVertices[9] = vVertices[4];

	vVertices[13] = 18/64.0f+vVertices[3];
	vVertices[14] = 12/64.0f+vVertices[4];

	vVertices[18] = vVertices[3];
	vVertices[19] = 12/64.0f+vVertices[4];

	gvTexCoordHandleT = glGetAttribLocation(gProgramT, "a_texCoord");
	glEnableVertexAttribArray(gvTexCoordHandleT);
	glVertexAttribPointer(gvTexCoordHandleT, 2, GL_FLOAT, GL_FALSE, stride, &vVertices[3]);

	gvSamplerHandleT = glGetAttribLocation(gProgramT, "s_texture");
	glUniform1i(gvSamplerHandleT, 0);

	gvPositionHandleT = glGetAttribLocation(gProgramT, "a_position");
	glVertexAttribPointer(gvPositionHandleT, 3, GL_FLOAT, GL_FALSE, stride,vVertices);
		
    glDrawElements(GL_TRIANGLES, 6, GL_UNSIGNED_SHORT, indices);

}
GLfloat vMatrix[] = 
	{
    1.0f, 0.0f, 0.0f, 0.0f,
    0.0f, 1.0f, 0.0f, 0.0f,
    0.0f, 0.0f, 1.0f, 0.0f,
    camX,   0,    0,  1.0f
	};

void Camera(GLuint program)
{	
	vMatrix[12]=camX;
	GLint c = glGetUniformLocation(program,"uMVPMatrix");
	glUniformMatrix4fv(c,1,false, vMatrix);
}
		

#pragma endregion


//количество собранных монеток
int coinsInPocket=0;

//функция отрисовки
void renderFrame() 
{   
    glClearColor(0, 0, 0, 1.0f);
    glClear( GL_DEPTH_BUFFER_BIT | GL_COLOR_BUFFER_BIT);
	
	switch (GS)
	{
	case gsSTART:	
		Camera(gProgram);
	
	    glUseProgram(gProgram);
		DrawButton();
		break;
	case gsFINISH:
		Camera(gProgramT);
	
		glUseProgram(gProgramT);
        	    
		if (timer<480)
		{
			DrawNumber(NumPos[0],++timer);
			DrawNumber(NumPos[1],++timer);
			DrawNumber(NumPos[2],++timer);
			DrawNumber(NumPos[3],++timer);
		}
		else
		{
			DrawNumber(NumPos[0],9);
			DrawNumber(NumPos[1],9);
			DrawNumber(NumPos[2],(9+(coinsInPocket%100/10))%10);
			DrawNumber(NumPos[3],(9+coinsInPocket%10)%10);	

		}

		break;
	case gsGAME:
		Camera(gProgram);	
	    glUseProgram(gProgram);
		
		for (int i=0;i<platfromsCount;++i)
			DrawRectangle(platforms[i]);
		for (int i=0;i<coinsCount;++i)
			DrawCoin(coins[i]);
		DrawRectangle(Player);
	break;
	}
}

///////////////////////////////LOGIC//////////////////////




//состояние персонажа - на земле или в прыжке
bool OnGround=false;
bool OldOnGroung;

//импульс физики, каждый апдейт прибавляется к позиции игрока
Vector2 *Impulse = new Vector2(0,0);

void MovePlayer(float x,float y)
{
	Impulse->X+=x;
	Impulse->Y+=y;

}

//рестарт и в африке, ну да. рестарт сцены игры
void Restart()
{
	timer=0;

	coinsInPocket=0;

	Player->Position->X=-.6;
	Player->Position->Y=0;
	
	Impulse->X=0;
	Impulse->Y=0;
	
	OnGround=false; 
	OldOnGroung=false;

	for (int i=0;i<coinsCount;++i)
		coins[i]->IsVisible=true;

	GS = gsGAME;
}
//fires for every touch (1,2,3,4)
void Touch(int x,int y)
{
	switch (GS)
	{
	case gsSTART:GS = gsGAME;
		break;
	case gsFINISH:	
		if (timer>=480)
			Restart();	
		
		break;
	case gsGAME:

		if (OnGround)
		{
			if (x<screenW/4.0f)//left
				MovePlayer(-0.01f,0);
			else
			{
				if (x<screenW/2.0f) //right
					MovePlayer(0.01f,0);
				else
					if (x>screenW/2.0f) //jump
						MovePlayer(0, 0.03f); 			
			}
		}
		break;
	}
}

//апдейт сцены, привет XNA
void Update()
{
	switch (GS)
	{
	case gsSTART:  break;
	case gsFINISH: break;
	case gsGAME:
		#pragma region move
		OnGround=false;
		for (int i=0;i<platfromsCount;++i) //как вариант проверки нахождения перса на платформе
			if ((Player->Position->X+Player->Width > platforms[i]->Position->X)&&
				(Player->Position->X < platforms[i]->Position->X+platforms[i]->Width)&&
				(Player->Position->Y+Player->Height > platforms[i]->Position->Y)&&
				(Player->Position->Y < platforms[i]->Position->Y+platforms[i]->Height))
				OnGround=true;

		//падение
		if (OnGround)
		{
			Impulse->X = fabsf(Impulse->X)>0.001f?Impulse->X/=2.0f:0;
			if (OldOnGroung==false) //упали
				Impulse->Y= fabsf(Impulse->Y)>0.001f?Impulse->Y=-Impulse->Y+(Impulse->Y/1.2f):0;
		}
		else Impulse->Y-=0.003f;
		
		//расчет финального импульса физики
		Player->Position->X+=Impulse->X;
		Player->Position->Y+=Impulse->Y;

		OldOnGroung=OnGround;
		#pragma endregion

		//сбор монеток
		for (int i=0;i<coinsCount;++i)
			if ((Vector2::Length(Player->Position,coins[i]->Position)<0.1)&&
				(coins[i]->IsVisible==true))//это, конечно, ерунда. проверяется окружность вокруг левого верхнего угла персонажа, но в демонстрационных целях прокатит
			{
				coins[i]->IsVisible=false;
				++coinsInPocket;
			}

		//двигаем камеру
		camX=-Player->Position->X;

		//переходим на другие экраны
		if ((Player->Position->Y<-1)||(Player->Position->X>3.4f)) 
		{
			GS = gsFINISH;		
			camX=0;
		}
		
		break;
	}

}

#pragma  region JAVA communicate
extern "C" 
{
	JNIEXPORT void JNICALL Java_com_android_gl2jni_GL2JNILib_init(JNIEnv * env, jobject obj,  jint width, jint height);
	JNIEXPORT void JNICALL Java_com_android_gl2jni_GL2JNILib_step(JNIEnv * env, jobject obj);
	JNIEXPORT void JNICALL Java_com_android_gl2jni_GL2JNILib_touch(JNIEnv * env, jobject obj, jint x, jint y);
	
};

JNIEXPORT void JNICALL Java_com_android_gl2jni_GL2JNILib_init(JNIEnv * env, jobject obj,  jint width, jint height)
{
	setupGraphics(width, height);
}


JNIEXPORT void JNICALL Java_com_android_gl2jni_GL2JNILib_step(JNIEnv * env, jobject obj)
{
	Update();
    renderFrame();
}


JNIEXPORT void JNICALL Java_com_android_gl2jni_GL2JNILib_touch(JNIEnv * env, jobject obj,jint x, jint y)
{
    Touch(x,y);
}

#pragma endregion
